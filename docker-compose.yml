services:
  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/New_York}
      - VERSION=docker
      - PLEX_CLAIM=${PLEX_CLAIM}
    volumes:
      - plex_config:/config
      - plex_transcode:/transcode
      - media_movies:/data/movies
      - media_tv:/data/tv
      - media_music:/data/music
    ports:
      - "32400:32400"
      - "1900:1900/udp"
      - "3005:3005"
      - "5353:5353/udp"
      - "8324:8324"
      - "32410:32410/udp"
      - "32412:32412/udp"
      - "32413:32413/udp"
      - "32414:32414/udp"
      - "32469:32469"
    restart: unless-stopped
    networks:
      - homeserver
    depends_on:
      - loki
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    volumes:
      - cloudflared_config:/home/nonroot/.cloudflared
    networks:
      - homeserver
    depends_on:
      - plex
      - loki
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Monitoring and Logging Stack
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3000
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
    volumes:
      - grafana_data:/var/lib/grafana
      - grafana_config:/etc/grafana/provisioning
      - grafana_dashboards:/var/lib/grafana/dashboards
    ports:
      - "3000:3000"
    networks:
      - homeserver
    depends_on:
      - loki
      - prometheus
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  loki:
    image: grafana/loki:latest
    container_name: loki
    restart: unless-stopped
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - loki_data:/loki
      - loki_config:/etc/loki
    ports:
      - "3100:3100"
    networks:
      - homeserver
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    restart: unless-stopped
    command: -config.file=/etc/promtail/config.yml
    volumes:
      - promtail_config:/etc/promtail
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    networks:
      - homeserver
    depends_on:
      - loki
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
    volumes:
      - prometheus_data:/prometheus
      - prometheus_config:/etc/prometheus
    ports:
      - "9090:9090"
    networks:
      - homeserver
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    restart: unless-stopped
    command:
      - '--path.rootfs=/host'
    volumes:
      - '/:/host:ro'
    ports:
      - "9100:9100"
    networks:
      - homeserver
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ:-America/New_York}
      - WEBUI_PORT=8080
    volumes:
      - qbittorrent_config:/config
      - downloads_complete:/downloads
      - downloads_incomplete:/downloads/incomplete
    ports:
      - "8080:8080"
      - "6881:6881"
      - "6881:6881/udp"
    networks:
      - homeserver
    # depends_on removed: qBittorrent does not require loki
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  # Media volumes
  plex_config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/external-hdd/plex/config
  
  plex_transcode:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/external-hdd/plex/transcode
  
  media_movies:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/external-hdd/media/movies
  
  media_tv:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/external-hdd/media/tv
  
  media_music:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/external-hdd/media/music

  # Download volumes
  qbittorrent_config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/external-hdd/qbittorrent/config

  downloads_complete:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/external-hdd/downloads/complete

  downloads_incomplete:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/external-hdd/downloads/incomplete

  # Cloudflare volume
  cloudflared_config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/external-hdd/cloudflared/config

  # Monitoring volumes
  grafana_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/external-hdd/monitoring/grafana/data

  grafana_config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/external-hdd/monitoring/grafana/config/provisioning

  grafana_dashboards:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/external-hdd/monitoring/grafana/config/dashboards

  loki_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/external-hdd/monitoring/loki/data

  loki_config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/external-hdd/monitoring/loki/config

  promtail_config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/external-hdd/monitoring/promtail/config

  prometheus_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/external-hdd/monitoring/prometheus/data

  prometheus_config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/external-hdd/monitoring/prometheus/config

networks:
  homeserver:
    driver: bridge